function safeStringify(a){var b;try{b=JSON.stringify(a)}catch(c){b=_safeStringify(a)}return b}function isReadStream(a){return a.readable&&a.path&&a.mode?!0:void 0}function toBase64(a){return new Buffer(a||"","ascii").toString("base64")}function md5(a){return crypto.createHash("md5").update(a).digest("hex")}function Request(a){stream.Stream.call(this),this.readable=!0,this.writable=!0,"string"==typeof a&&(a={uri:a});var b=Object.keys(Request.prototype);for(var c in a)-1===b.indexOf(c)?this[c]=a[c]:"function"==typeof a[c]&&delete a[c];a.method&&(this.explicitMethod=!0),this.canTunnel=a.tunnel!==!1&&tunnel,this.init(a)}function toJSON(){return getSafe(this,"__"+(65536*(1+Math.random())|0).toString(16))}var optional=require("./lib/optional"),http=require("http"),https=optional("https"),tls=optional("tls"),url=require("url"),util=require("util"),stream=require("stream"),qs=require("qs"),querystring=require("querystring"),crypto=require("crypto"),oauth=optional("oauth-sign"),hawk=optional("hawk"),aws=optional("aws-sign"),httpSignature=optional("http-signature"),uuid=require("node-uuid"),mime=require("mime"),tunnel=optional("tunnel-agent"),_safeStringify=require("json-stringify-safe"),ForeverAgent=require("forever-agent"),FormData=optional("form-data"),Cookie=optional("tough-cookie"),CookieJar=Cookie&&Cookie.CookieJar,cookieJar=CookieJar&&new CookieJar,copy=require("./lib/copy"),debug=require("./lib/debug"),getSafe=require("./lib/getSafe"),globalPool={},isUrl=/^https?:/i;https&&!https.Agent&&(https.Agent=function(a){http.Agent.call(this,a)},util.inherits(https.Agent,http.Agent),https.Agent.prototype._getConnection=function(a,b,c){var d=tls.connect(b,a,this.options,function(){c&&c()});return d}),util.inherits(Request,stream.Stream),Request.prototype.init=function(a){var b=this;if(a||(a={}),b.method||(b.method=a.method||"GET"),b.localAddress=a.localAddress,debug(a),b.pool||b.pool===!1||(b.pool=globalPool),b.dests=b.dests||[],b.__isRequestRequest=!0,!b._callback&&b.callback&&(b._callback=b.callback,b.callback=function(){b._callbackCalled||(b._callbackCalled=!0,b._callback.apply(b,arguments))},b.on("error",b.callback.bind()),b.on("complete",b.callback.bind(b,null))),b.url&&!b.uri&&(b.uri=b.url,delete b.url),!b.uri)return b.emit("error",new Error("options.uri is a required argument"));if("string"==typeof b.uri&&(b.uri=url.parse(b.uri)),b.strictSSL===!1&&(b.rejectUnauthorized=!1),b.proxy&&("string"==typeof b.proxy&&(b.proxy=url.parse(b.proxy)),http.globalAgent&&"https:"===b.uri.protocol&&b.canTunnel)){var c="http:"===b.proxy.protocol?tunnel.httpsOverHttp:tunnel.httpsOverHttps,d={proxy:{host:b.proxy.hostname,port:+b.proxy.port,proxyAuth:b.proxy.auth,headers:{Host:b.uri.hostname+":"+(b.uri.port||"https:"===b.uri.protocol?443:80)}},rejectUnauthorized:b.rejectUnauthorized,ca:this.ca};b.agent=c(d),b.tunnel=!0}if(b.uri.pathname||(b.uri.pathname="/"),!b.uri.host){var e=url.format(b.uri),f='Invalid URI "'+e+'"';return 0===Object.keys(a).length&&(f+=". This can be caused by a crappy redirection."),void b.emit("error",new Error(f))}if(b._redirectsFollowed=b._redirectsFollowed||0,b.maxRedirects=void 0!==b.maxRedirects?b.maxRedirects:10,b.followRedirect=void 0!==b.followRedirect?b.followRedirect:!0,b.followAllRedirects=void 0!==b.followAllRedirects?b.followAllRedirects:!1,(b.followRedirect||b.followAllRedirects)&&(b.redirects=b.redirects||[]),b.headers=b.headers?copy(b.headers):{},b.setHost=!1,b.hasHeader("host")||(b.setHeader("host",b.uri.hostname),b.uri.port&&(80===b.uri.port&&"http:"===b.uri.protocol||443===b.uri.port&&"https:"===b.uri.protocol||b.setHeader("host",b.getHeader("host")+(":"+b.uri.port))),b.setHost=!0),b.jar(b._jar||a.jar),b.uri.port||("http:"==b.uri.protocol?b.uri.port=80:"https:"==b.uri.protocol&&(b.uri.port=443)),b.proxy&&!b.tunnel?(b.port=b.proxy.port,b.host=b.proxy.hostname):(b.port=b.uri.port,b.host=b.uri.hostname),b.clientErrorHandler=function(a){if(!b._aborted){if(b.req&&b.req._reusedSocket&&"ECONNRESET"===a.code&&b.agent.addRequestNoreuse)return b.agent={addRequest:b.agent.addRequestNoreuse.bind(b.agent)},b.start(),void b.req.end();b.timeout&&b.timeoutTimer&&(clearTimeout(b.timeoutTimer),b.timeoutTimer=null),b.emit("error",a)}},b._parserErrorHandler=function(a){this.res?this.res.request?this.res.request.emit("error",a):this.res.emit("error",a):this._httpMessage.emit("error",a)},a.form&&b.form(a.form),a.qs&&b.qs(a.qs),b.path=b.uri.path?b.uri.path:b.uri.pathname+(b.uri.search||""),0===b.path.length&&(b.path="/"),a.oauth&&b.oauth(a.oauth),a.aws&&b.aws(a.aws),a.hawk&&b.hawk(a.hawk),a.httpSignature&&b.httpSignature(a.httpSignature),a.auth&&(Object.prototype.hasOwnProperty.call(a.auth,"username")&&(a.auth.user=a.auth.username),Object.prototype.hasOwnProperty.call(a.auth,"password")&&(a.auth.pass=a.auth.password),b.auth(a.auth.user,a.auth.pass,a.auth.sendImmediately)),b.uri.auth&&!b.hasHeader("authorization")){var g=b.uri.auth.split(":").map(function(a){return querystring.unescape(a)});b.auth(g[0],g.slice(1).join(":"),!0)}if(b.proxy&&b.proxy.auth&&!b.hasHeader("proxy-authorization")&&!b.tunnel&&b.setHeader("proxy-authorization","Basic "+toBase64(b.proxy.auth.split(":").map(function(a){return querystring.unescape(a)}).join(":"))),b.proxy&&!b.tunnel&&(b.path=b.uri.protocol+"//"+b.uri.host+b.path),a.json?b.json(a.json):a.multipart&&(b.boundary=uuid(),b.multipart(a.multipart)),b.body){var h=0;if(Buffer.isBuffer(b.body))h=b.body.length;else if(Array.isArray(b.body))for(var i=0;i<b.body.length;i++)h+=b.body[i].length;else b.body=new Buffer(b.body),h=b.body.length;if(!h)throw new Error("Argument error, options.body.");b.hasHeader("content-length")||b.setHeader("content-length",h)}var j=b.proxy&&!b.tunnel?b.proxy.protocol:b.uri.protocol,k={"http:":http,"https:":https},l=b.httpModules||{};return b.httpModule=l[j]||k[j],b.httpModule?(a.ca&&(b.ca=a.ca),b.agent||(a.agentOptions&&(b.agentOptions=a.agentOptions),b.agentClass=a.agentClass?a.agentClass:a.forever?"http:"===j?ForeverAgent:ForeverAgent.SSL:b.httpModule.Agent),b.pool===!1?b.agent=!1:(b.agent=b.agent||b.getAgent(),b.maxSockets&&(b.agent.maxSockets=b.maxSockets),b.pool.maxSockets&&(b.agent.maxSockets=b.pool.maxSockets)),b.on("pipe",function(a){if(b.ntick&&b._started)throw new Error("You cannot pipe to this stream after the outbound request has started.");if(b.src=a,isReadStream(a))b.hasHeader("content-type")||b.setHeader("content-type",mime.lookup(a.path));else{if(a.headers)for(var c in a.headers)b.hasHeader(c)||b.setHeader(c,a.headers[c]);b._json&&!b.hasHeader("content-type")&&b.setHeader("content-type","application/json"),a.method&&!b.explicitMethod&&(b.method=a.method)}}),void process.nextTick(function(){b._aborted||(b._form&&(b.setHeaders(b._form.getHeaders()),b._form.pipe(b)),b.body?(Array.isArray(b.body)?b.body.forEach(function(a){b.write(a)}):b.write(b.body),b.end()):b.requestBodyStream?(console.warn("options.requestBodyStream is deprecated, please pass the request object to stream.pipe."),b.requestBodyStream.pipe(b)):b.src||("GET"!==b.method&&"undefined"!=typeof b.method&&b.setHeader("content-length",0),b.end()),b.ntick=!0)})):this.emit("error",new Error("Invalid protocol"))},Request.prototype._updateProtocol=function(){var a=this,b=a.uri.protocol;if("https:"===b){if(a.proxy&&a.canTunnel){a.tunnel=!0;var c="http:"===a.proxy.protocol?tunnel.httpsOverHttp:tunnel.httpsOverHttps,d={proxy:{host:a.proxy.hostname,port:+a.proxy.port,proxyAuth:a.proxy.auth},rejectUnauthorized:a.rejectUnauthorized,ca:a.ca};return void(a.agent=c(d))}switch(a.httpModule=https,a.agentClass){case ForeverAgent:a.agentClass=ForeverAgent.SSL;break;case http.Agent:a.agentClass=https.Agent;break;default:return}a.agent&&(a.agent=a.getAgent())}else{switch(a.tunnel&&(a.tunnel=!1),a.httpModule=http,a.agentClass){case ForeverAgent.SSL:a.agentClass=ForeverAgent;break;case https.Agent:a.agentClass=http.Agent;break;default:return}a.agent&&(a.agent=null,a.agent=a.getAgent())}},Request.prototype.getAgent=function(){var a=this.agentClass,b={};if(this.agentOptions)for(var c in this.agentOptions)b[c]=this.agentOptions[c];this.ca&&(b.ca=this.ca),this.ciphers&&(b.ciphers=this.ciphers),this.secureProtocol&&(b.secureProtocol=this.secureProtocol),"undefined"!=typeof this.rejectUnauthorized&&(b.rejectUnauthorized=this.rejectUnauthorized),this.cert&&this.key&&(b.key=this.key,b.cert=this.cert);var d="";a!==this.httpModule.Agent&&(d+=a.name),this.httpModule.globalAgent||(b.host=this.host,b.port=this.port,d&&(d+=":"),d+=this.host+":"+this.port);var e=this.proxy;"string"==typeof e&&(e=url.parse(e));var f=e&&"https:"===e.protocol||"https:"===this.uri.protocol;return f&&(b.ca&&(d&&(d+=":"),d+=b.ca),"undefined"!=typeof b.rejectUnauthorized&&(d&&(d+=":"),d+=b.rejectUnauthorized),b.cert&&(d+=b.cert.toString("ascii")+b.key.toString("ascii")),b.ciphers&&(d&&(d+=":"),d+=b.ciphers),b.secureProtocol&&(d&&(d+=":"),d+=b.secureProtocol)),this.pool===globalPool&&!d&&0===Object.keys(b).length&&this.httpModule.globalAgent?this.httpModule.globalAgent:(d=this.uri.protocol+d,this.pool[d]?this.pool[d]:this.pool[d]=new a(b))},Request.prototype.start=function(){var a=this;if(!a._aborted){a._started=!0,a.method=a.method||"GET",a.href=a.uri.href,a.src&&a.src.stat&&a.src.stat.size&&!a.hasHeader("content-length")&&a.setHeader("content-length",a.src.stat.size),a._aws&&a.aws(a._aws,!0);var b=copy(a);delete b.auth,debug("make request",a.uri.href),a.req=a.httpModule.request(b,a.onResponse.bind(a)),a.timeout&&!a.timeoutTimer&&(a.timeoutTimer=setTimeout(function(){a.req.abort();var b=new Error("ETIMEDOUT");b.code="ETIMEDOUT",a.emit("error",b)},a.timeout),a.req.setTimeout&&a.req.setTimeout(a.timeout,function(){if(a.req){a.req.abort();var b=new Error("ESOCKETTIMEDOUT");b.code="ESOCKETTIMEDOUT",a.emit("error",b)}})),a.req.on("error",a.clientErrorHandler),a.req.on("drain",function(){a.emit("drain")}),a.on("end",function(){a.req.connection&&a.req.connection.removeListener("error",a._parserErrorHandler)}),a.emit("request",a.req)}},Request.prototype.onResponse=function(a){var b=this;if(debug("onResponse",b.uri.href,a.statusCode,a.headers),a.on("end",function(){debug("response end",b.uri.href,a.statusCode,a.headers)}),-1===a.connection.listeners("error").indexOf(b._parserErrorHandler)&&a.connection.once("error",b._parserErrorHandler),b._aborted)return debug("aborted",b.uri.href),void a.resume();if(b._paused?a.pause():a.resume(),b.response=a,a.request=b,a.toJSON=toJSON,b.httpModule===https&&b.strictSSL&&!a.client.authorized){debug("strict ssl error",b.uri.href);var c=a.client.authorizationError;return void b.emit("error",new Error("SSL Error: "+c))}b.setHost&&b.hasHeader("host")&&delete b.headers[b.hasHeader("host")],b.timeout&&b.timeoutTimer&&(clearTimeout(b.timeoutTimer),b.timeoutTimer=null);var d=function(a){if(b._jar){var c=b._jar.setCookie?b._jar:cookieJar;c.setCookie(a,b.uri.href,function(a){a&&console.warn("set cookie failed,"+a)})}};if(hasHeader("set-cookie",a.headers)&&!b._disableCookies){var e=hasHeader("set-cookie",a.headers);Array.isArray(a.headers[e])?a.headers[e].forEach(d):d(a.headers[e])}var f=null;if(a.statusCode>=300&&a.statusCode<400&&hasHeader("location",a.headers)){var g=a.headers[hasHeader("location",a.headers)];if(debug("redirect",g),b.followAllRedirects)f=g;else if(b.followRedirect)switch(b.method){case"PATCH":case"PUT":case"POST":case"DELETE":break;default:f=g}}else if(401==a.statusCode&&b._hasAuth&&!b._sentAuth){var h=a.headers[hasHeader("www-authenticate",a.headers)],i=h&&h.split(" ")[0];switch(debug("reauth",i),i){case"Basic":b.auth(b._user,b._pass,!0),f=b.uri;break;case"Digest":for(var j=h.match(/([a-z0-9_-]+)="([^"]+)"/gi),k={},l=0;l<j.length;l++){var m=j[l].indexOf("="),n=j[l].substring(0,m),o=j[l].substring(m+1);k[n]=o.substring(1,o.length-1)}var p=md5(b._user+":"+k.realm+":"+b._pass),q=md5(b.method+":"+b.uri.path),r=uuid().replace(/-/g,""),s=md5(p+":"+k.nonce+":1:"+r+":auth:"+q),t={username:b._user,realm:k.realm,nonce:k.nonce,uri:b.uri.path,qop:k.qop,response:s,nc:1,cnonce:r};h=[];for(var u in t)h.push(u+'="'+t[u]+'"');h="Digest "+h.join(", "),b.setHeader("authorization",h),b._sentAuth=!0,f=b.uri}}if(f){if(debug("redirect to",f),b._paused&&a.resume(),b._redirectsFollowed>=b.maxRedirects)return void b.emit("error",new Error("Exceeded maxRedirects. Probably stuck in a redirect loop "+b.uri.href));b._redirectsFollowed+=1,isUrl.test(f)||(f=url.resolve(b.uri.href,f));var v=b.uri;return b.uri=url.parse(f),b.uri.protocol!==v.protocol&&b._updateProtocol(),b.redirects.push({statusCode:a.statusCode,redirectUri:f}),b.followAllRedirects&&401!=a.statusCode&&(b.method="GET"),delete b.src,delete b.req,delete b.agent,delete b._started,401!=a.statusCode&&(delete b.body,delete b._form,b.headers&&(b.hasHeader("host")&&delete b.headers[b.hasHeader("host")],b.hasHeader("content-type")&&delete b.headers[b.hasHeader("content-type")],b.hasHeader("content-length")&&delete b.headers[b.hasHeader("content-length")])),b.emit("redirect"),void b.init()}if(b._redirectsFollowed=b._redirectsFollowed||0,a.on("close",function(){b._ended||b.response.emit("end")}),b.encoding&&(0!==b.dests.length?console.error("Ignoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid."):a.setEncoding(b.encoding)),b.emit("response",a),b.dests.forEach(function(a){b.pipeDest(a)}),a.on("data",function(a){b._destdata=!0,b.emit("data",a)}),a.on("end",function(a){b._ended=!0,b.emit("end",a)}),a.on("close",function(){b.emit("close")}),b.callback){var w=[],x=0;b.on("data",function(a){w.push(a),x+=a.length}),b.on("end",function(){if(debug("end event",b.uri.href),b._aborted)return void debug("aborted",b.uri.href);if(w.length&&Buffer.isBuffer(w[0])){debug("has body",b.uri.href,x);var c=new Buffer(x),d=0;w.forEach(function(a){a.copy(c,d,0,a.length),d+=a.length}),a.body=null===b.encoding?c:c.toString(b.encoding)}else w.length&&("utf8"===b.encoding&&w[0].length>0&&"﻿"===w[0][0]&&(w[0]=w[0].substring(1)),a.body=w.join(""));if(b._json)try{a.body=JSON.parse(a.body)}catch(e){}debug("emitting complete",b.uri.href),void 0!=a.body||b._json||(a.body=""),b.emit("complete",a,a.body)})}else b.on("end",function(){return b._aborted?void debug("aborted",b.uri.href):void b.emit("complete",a)});debug("finish init function",b.uri.href)},Request.prototype.abort=function(){this._aborted=!0,this.req?this.req.abort():this.response&&this.response.abort(),this.emit("abort")},Request.prototype.pipeDest=function(a){var b=this.response;if(a.headers&&!a.headersSent){if(hasHeader("content-type",b.headers)){var c=hasHeader("content-type",b.headers);a.setHeader?a.setHeader(c,b.headers[c]):a.headers[c]=b.headers[c]}if(hasHeader("content-length",b.headers)){var d=hasHeader("content-length",b.headers);a.setHeader?a.setHeader(d,b.headers[d]):a.headers[d]=b.headers[d]}}if(a.setHeader&&!a.headersSent){for(var e in b.headers)a.setHeader(e,b.headers[e]);a.statusCode=b.statusCode}this.pipefilter&&this.pipefilter(b,a)},Request.prototype.setHeader=function(a,b,c){return void 0===c&&(c=!0),c||!this.hasHeader(a)?this.headers[a]=b:this.headers[this.hasHeader(a)]+=","+b,this},Request.prototype.setHeaders=function(a){for(var b in a)this.setHeader(b,a[b]);return this},Request.prototype.hasHeader=function(a,b){var b=Object.keys(b||this.headers),c=b.map(function(a){return a.toLowerCase()});a=a.toLowerCase();for(var d=0;d<c.length;d++)if(c[d]===a)return b[d];return!1};var hasHeader=Request.prototype.hasHeader;Request.prototype.qs=function(a,b){var c;c=!b&&this.uri.query?qs.parse(this.uri.query):{};for(var d in a)c[d]=a[d];return""===qs.stringify(c)?this:(this.uri=url.parse(this.uri.href.split("?")[0]+"?"+qs.stringify(c)),this.url=this.uri,this.path=this.uri.path,this)},Request.prototype.form=function(a){return a?(this.setHeader("content-type","application/x-www-form-urlencoded; charset=utf-8"),this.body=qs.stringify(a).toString("utf8"),this):(this._form=new FormData,this._form)},Request.prototype.multipart=function(a){var b=this;if(b.body=[],b.hasHeader("content-type")){var c=b.hasHeader("content-type");b.setHeader(c,b.headers[c].split(";")[0]+"; boundary="+b.boundary)}else b.setHeader("content-type","multipart/related; boundary="+b.boundary);if(!a.forEach)throw new Error("Argument error, options.multipart.");return b.preambleCRLF&&b.body.push(new Buffer("\r\n")),a.forEach(function(a){var c=a.body;if(null==c)throw Error("Body attribute missing in multipart.");delete a.body;var d="--"+b.boundary+"\r\n";Object.keys(a).forEach(function(b){d+=b+": "+a[b]+"\r\n"}),d+="\r\n",b.body.push(new Buffer(d)),b.body.push(new Buffer(c)),b.body.push(new Buffer("\r\n"))}),b.body.push(new Buffer("--"+b.boundary+"--")),b},Request.prototype.json=function(a){var b=this;return b.hasHeader("accept")||b.setHeader("accept","application/json"),this._json=!0,"boolean"==typeof a?"object"==typeof this.body&&(this.body=safeStringify(this.body),b.setHeader("content-type","application/json")):(this.body=safeStringify(a),b.setHeader("content-type","application/json")),this},Request.prototype.getHeader=function(a,b){var c,d,e;return b||(b=this.headers),Object.keys(b).forEach(function(f){d=new RegExp(a,"i"),e=f.match(d),e&&(c=b[f])}),c};var getHeader=Request.prototype.getHeader;Request.prototype.auth=function(a,b,c){if("string"!=typeof a||void 0!==b&&"string"!=typeof b)throw new Error("auth() received invalid user or password");this._user=a,this._pass=b,this._hasAuth=!0;var d="undefined"!=typeof b?a+":"+b:a;return(c||"undefined"==typeof c)&&(this.setHeader("authorization","Basic "+toBase64(d)),this._sentAuth=!0),this},Request.prototype.aws=function(a,b){if(!b)return this._aws=a,this;var c=new Date;this.setHeader("date",c.toUTCString());var d={key:a.key,secret:a.secret,verb:this.method.toUpperCase(),date:c,contentType:this.getHeader("content-type")||"",md5:this.getHeader("content-md5")||"",amazonHeaders:aws.canonicalizeHeaders(this.headers)};return a.bucket&&this.path?d.resource="/"+a.bucket+this.path:a.bucket&&!this.path?d.resource="/"+a.bucket:!a.bucket&&this.path?d.resource=this.path:a.bucket||this.path||(d.resource="/"),d.resource=aws.canonicalizeResource(d.resource),this.setHeader("authorization",aws.authorization(d)),this},Request.prototype.httpSignature=function(a){var b=this;return httpSignature.signRequest({getHeader:function(a){return getHeader(a,b.headers)},setHeader:function(a,c){b.setHeader(a,c)},method:this.method,path:this.path},a),debug("httpSignature authorization",this.getHeader("authorization")),this},Request.prototype.hawk=function(a){this.setHeader("Authorization",hawk.client.header(this.uri,this.method,a).field)},Request.prototype.oauth=function(a){var b;this.hasHeader("content-type")&&"application/x-www-form-urlencoded"===this.getHeader("content-type").slice(0,"application/x-www-form-urlencoded".length)&&(b=qs.parse(this.body)),this.uri.query&&(b=qs.parse(this.uri.query)),b||(b={});var c={};for(var d in b)c[d]=b[d];for(var d in a)c["oauth_"+d]=a[d];c.oauth_version||(c.oauth_version="1.0"),c.oauth_timestamp||(c.oauth_timestamp=Math.floor(Date.now()/1e3).toString()),c.oauth_nonce||(c.oauth_nonce=uuid().replace(/-/g,"")),c.oauth_signature_method="HMAC-SHA1";var e=c.oauth_consumer_secret;delete c.oauth_consumer_secret;var f=c.oauth_token_secret;delete c.oauth_token_secret;var g=c.oauth_timestamp,h=this.uri.protocol+"//"+this.uri.host+this.uri.pathname,i=oauth.hmacsign(this.method,h,c,e,f);for(var d in b)d.slice(0,"oauth_")in a||(delete c["oauth_"+d],"x_auth_mode"!==d&&delete c[d]);c.oauth_timestamp=g;var j="OAuth "+Object.keys(c).sort().map(function(a){return a+'="'+oauth.rfc3986(c[a])+'"'}).join(",");return j+=',oauth_signature="'+oauth.rfc3986(i)+'"',this.setHeader("Authorization",j),this},Request.prototype.jar=function(a){var b;if(0===this._redirectsFollowed&&(this.originalCookieHeader=this.getHeader("cookie")),a){var c=a&&a.getCookieString?a:cookieJar,d=this.uri.href;c.getCookieString(d,function(a,c){a?console.warn("get cookieString failed,"+a):b=c})}else b=!1,this._disableCookies=!0;return b&&b.length&&(this.originalCookieHeader?this.setHeader("cookie",this.originalCookieHeader+"; "+b):this.setHeader("cookie",b)),this._jar=a,this},Request.prototype.pipe=function(a,b){if(this.response){if(this._destdata)throw new Error("You cannot pipe after data has been emitted from the response.");if(this._ended)throw new Error("You cannot pipe after the response has been ended.");return stream.Stream.prototype.pipe.call(this,a,b),this.pipeDest(a),a}return this.dests.push(a),stream.Stream.prototype.pipe.call(this,a,b),a},Request.prototype.write=function(){return this._started||this.start(),this.req.write.apply(this.req,arguments)},Request.prototype.end=function(a){a&&this.write(a),this._started||this.start(),this.req.end()},Request.prototype.pause=function(){this.response?this.response.pause.apply(this.response,arguments):this._paused=!0},Request.prototype.resume=function(){this.response?this.response.resume.apply(this.response,arguments):this._paused=!1},Request.prototype.destroy=function(){this._ended?this.response&&this.response.destroy():this.end()},Request.prototype.toJSON=toJSON,module.exports=Request;